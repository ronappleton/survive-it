name: tag-release

on:
  workflow_dispatch:
    inputs:
      bump:
        description: "major, minor, patch (ignored if version is set)"
        required: true
        default: "minor"
        type: choice
        options: [patch, minor, major]
      version:
        description: "Optional explicit tag (e.g. v1.2.3). Overrides bump."
        required: false
        type: string

permissions:
  contents: write

jobs:
  tag:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch tags
        run: git fetch --tags --force

      - name: Compute tag
        id: compute
        shell: bash
        run: |
          set -euo pipefail

          if [ -n "${{ inputs.version }}" ]; then
            V="${{ inputs.version }}"
            echo "$V" | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' >/dev/null
            echo "tag=$V" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          LATEST="$(git tag -l 'v[0-9]*.[0-9]*.[0-9]*' --sort=-v:refname | head -n 1 || true)"
          if [ -z "$LATEST" ]; then
            echo "tag=v0.1.0" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          VER="${LATEST#v}"
          MAJOR="$(echo "$VER" | cut -d. -f1)"
          MINOR="$(echo "$VER" | cut -d. -f2)"
          PATCH="$(echo "$VER" | cut -d. -f3)"

          case "${{ inputs.bump }}" in
            major) MAJOR=$((MAJOR + 1)); MINOR=0; PATCH=0 ;;
            minor) MINOR=$((MINOR + 1)); PATCH=0 ;;
            patch) PATCH=$((PATCH + 1)) ;;
          esac

          echo "tag=v${MAJOR}.${MINOR}.${PATCH}" >> "$GITHUB_OUTPUT"

      - name: Fail if tag exists
        run: |
          TAG="${{ steps.compute.outputs.tag }}"
          git rev-parse "$TAG" >/dev/null 2>&1 && { echo "Tag exists: $TAG"; exit 1; } || true

      - name: Create and push tag
        run: |
          TAG="${{ steps.compute.outputs.tag }}"
          echo "Creating tag: $TAG"
          git tag "$TAG"
          git push origin "$TAG"